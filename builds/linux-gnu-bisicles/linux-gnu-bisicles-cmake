# run this script by typing: source hopper-pgi-cmake
# After thus script completes, type: make -j 8
# If rebuilding, type 'make clean' before running 'make -j 8'

# This cmake configuration script builds cism_driver


# This script should be run from the builds/linux-gnu-bisicles subdirectory
# of the main seacism repository (reflected in the two instances
# of "../.." below).

# BUILD OPTIONS:
# The call to cmake below include several input ON/OFF switch parameters, to
# provide a simple way to select different build options.  These are:
# USE_TRILINOS -- OFF by default, set to on for builds without Trilinos
# CISM_MPI_MODE -- ON by default, only set to OFF for serial builds
# CISM_SERIAL_MODE -- OFF by default, set to ON for serial builds.
#
# CISM_ENABLE_BISICLES -- OFF by default, set to ON to build a bisicles-enabled cism_driver.
#      Setting USE_TRILINOS to OFF will generate a much smaller executable for this build.
# CISM_BUILD_EXTRA_EXECUTABLES -- OFF by default, set to ON to build eis_glide and others
# CISM_USE_GPTL_INSTRUMENTATION -- OFF by default, set to ON to use GPTL instrumentation


# remove old build data:
rm -f ./CMakeCache.txt

# run a script that creates some CISM source files:
#pushd .
#cd ..
#../cmake-scripts/autogenerate-script
#popd

echo
echo "Doing CMake Configuration step"

#set Netcdf installation directory here
#setenv NETCDF_HOME /home/loren/users/dmartin/util/netcdf/netcdf-4.1.2 
#setenv NETCDF_HOME /usr/local/netcdf 
setenv NETCDF_HOME ${NETCDFHOME}

cmake \
  -D CISM_USE_TRILINOS:BOOL=OFF \
  -D CISM_COUPLED:BOOL=OFF \
  -D CISM_MPI_MODE:BOOL=ON \
  -D CISM_SERIAL_MODE:BOOL=OFF \
  -D CISM_BUILD_SIMPLE_GLIDE:BOOL=OFF \
  -D CISM_ENABLE_BISICLES:BOOL=ON \
  -D CISM_BUILD_EXTRA_EXECUTABLES:BOOL=OFF \
  -D CISM_USE_GPTL_INSTRUMENTATION:BOOL=OFF \
  -D CISM_USE_CISM_FRONT_END:BOOL=ON \
\
  -D CISM_NETCDF_DIR=${NETCDF_HOME} \
  -D CMAKE_INSTALL_PREFIX:PATH=$PWD/install \
  -D CMAKE_VERBOSE_MAKEFILE:BOOL=ON \
\
  -D CMAKE_CXX_COMPILER=mpiCC \
  -D CMAKE_C_COMPILER=mpicc \
  -D CMAKE_Fortran_COMPILER=mpif90 \
\
  -D CISM_HDF5_LIB_DIR=${ANAG_HDF5_DIR}/lib \
  -D CISM_HDF5_LIBS="-DH5_USE_16_API -lhdf5 -lz -lstdc++" \
  -D CMAKE_PREFIX_PATH="${ANAG_HDF5_DIR}" \
\
  -D CMAKE_CXX_FLAGS:STRING="-g -DH5_USE_16_API" \
  -D CISM_Fortran_FLAGS:STRING="-g  -ffree-line-length-none -fno-range-check -DNO_RESCALE" \
  -D CISM_EXTRA_LIBS:STRING="-lblas" \
  -D BISICLES_INTERFACE_DIR=$PWD/../../../BISICLES/CISM-interface/interface \
  -D BISICLES_LIB_SUBDIR=libgnu \
 ../..

# Note: last argument above  "../.."  is path to top seacism directory
